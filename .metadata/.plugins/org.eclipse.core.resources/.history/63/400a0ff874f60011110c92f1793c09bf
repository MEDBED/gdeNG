<?php
// Redirige l'utilisateur s'il est déjà identifié
if(!isset($_COOKIE["ID_UTILISATEUR"])){
      header("Location: ../logout.php");
}else{
	include_once("../header.inc.php");
	include_once("../include/functions.php");	
	/*require_once('../include/phpmailer/class.phpmailer.php');*/         
     // Une fois le formulaire envoyé     
     if(isset($_POST["add"])){                          
     	if (!empty($_POST['contrat0']) && !empty($_POST['date0'])){              
               // Connexion à la base de données
          	   connectSQL();          	
          	   include_once("../include/protect_var.php");                          
          	   // Vérification de l'unicité
          	   $result = @mysql_query("SELECT date FROM salaire WHERE id_contrat='" . $_POST['contrat0'] . "' AND date='" . $_POST['date0'] . "';");
          	   // Si une erreur survient
          	   if (@mysql_num_rows($result)>0){
          	   	echo "Une feuille de paie a déjà été créée pour cette période !";
          	   }else{
                     // Création
                     $req="INSERT INTO salaire(id_contrat,date) VALUES('" . $_POST['contrat0'] . "','" . $_POST['date0'] . "')";                       
                     $result = @mysql_query($req);                         
                     // Si une erreur survient
                     if(!$result){
                     	echo "Erreur d'accès à la base de données";
                     }else{                                                                                        
					 	//Message de confirmation
                        echo "Enregistrement effectué";                                                                                                                  
                     }                                                                                         
               // Fermeture de la connexion à la base de données
          	   }              
     	}else{echo "Vous devez sélectionenr un contrat ET une période !" ;
     	}                     
     }elseif (isset($_POST["valid"])){  
     	// Connexion à la base de données
     	connectSQL();
     	$reqContrat="SELECT declenchement_supp FROM contrat WHERE id='$_POST[id_contrat]'";
     	$resContrat=@mysql_fetch_array(@mysql_query($reqContrat));
     	include_once("../include/protect_var.php");    
     	for ($i=1;$i<=31;$i++){     		
     		if (!empty($_POST["heure_$i"])){
     			$heure_mois+=$_POST["heure_$i"];     			
     			$infos.="$i#".$_POST["heure_$i"]; 
     			$dateSem=mktime(0,0,0,$_POST['mois'],$i,$_POST['annee']);
     			$sem=date('W',$dateSem);
     			if ($_POST["heure_$i"]>0){
     				//echo "$i -> ".$_POST["heure_$i"].'<br/>';
     				$tabSem[$sem]+=$_POST["heure_$i"];   
     				if ($_POST["heure_$i"]>$_POST['nbHeureJour']){
     					$nbHeuresComp+=$_POST["heure_$i"]-$_POST['nbHeureJour'];
     				}				
     			}        			
     			$vu=$i;     			
     		}else{$infos.="$i#";}
     		if (!empty($_POST["repas_$i"])){
     			$repas_mois+=$_POST["repas_$i"];     			
     			$infos.="#".$_POST["repas_$i"];      			
     			$vu=$i;     			
     		}else{$infos.="#";
     		}
     		if (!empty($_POST["conges_$i"])){
     			$conges_mois+=$_POST["conges_$i"];
     			$infos.="#".$_POST["conges_$i"];
     			$vu=$i;
     		}else{$infos.="#";
     		}
     		if (!empty($_POST["abs_enfant_$i"])){
     			$abs_enfant_mois+=$_POST["abs_enfant_$i"];
     			$infos.="#".$_POST["abs_enfant_$i"];
     			$vu=$i;
     		}else{$infos.="#";
     		}
     		if (!empty($_POST["abs_asm_$i"])){
     			$abs_asm_mois+=$_POST["abs_asm_$i"];
     			$infos.="#".$_POST["abs_asm_$i"];
     			$vu=$i;
     		}else{$infos.="#";
     		}
     		if (!empty($vu)){$jour_mois++;}
     		$vu='';
     		if ($i<31){$infos.="@@";}
     	} 	
     	//Heures supp
     	foreach ($tabSem as $HeuresSem){
     		if ($nbHeuresSem>45){
     			$nbHeuresSupp+=$nbHeuresSem-$resContrat['declenchement_supp'];
     		}
     	}         	
     	$semaines_travaillees=$jour_mois/5;
     	$req="UPDATE salaire SET heure_mois='$heure_mois',jour_mois='$jour_mois',
		semaines_travaillees='$semaines_travaillees',
		heure_supp_mois='$nbHeuresSupp',
     	heure_comp_mois='$nbHeuresComp',
     	repas_mois='$repas_mois',
     	jour_formation_asm='$abs_asm_mois',
     	date_reglement='$_POST[date_reglement]',
     	mode_reglement='$_POST[mode_reglement]',
     	salaire_net='$_POST[salaire_net]',
     	conge_mois='$conges_mois',
     	absence_enfant='$abs_enfant_mois',
     	salaire_regul='$_POST[salaire_regul]',
     	cal_info='$infos'
     	WHERE id='$_POST[id]'";
     	$result = @mysql_query($req);     	     	
     	if(!$result){
			echo "Erreur d'accès à la base de données";
        }else{                                                                                        
			//Message de confirmation
			include("calculate.php");
            //echo "Enregistrement effectué";                                                                                                                  
        } 
     }elseif (isset($_POST["del"])){  
     	// Connexion à la base de données     	
     	connectSQL();
     	include_once("../include/protect_var.php");     	   
     	$req="DELETE FROM salaire WHERE id='$_POST[id]'";  
     	$result = @mysql_query($req);
     	if(!$result){
			echo "Erreur d'accès à la base de données";
        }else{                                                                                        
			//Message de confirmation
            echo "Suppression effectuée";                                                                                                                  
        } 
     }        
}
?>
