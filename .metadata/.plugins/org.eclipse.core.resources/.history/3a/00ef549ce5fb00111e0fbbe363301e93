<?PHP
session_start();
$page="enfant.php";
$script="scripts/update_enfant.php";
$titre="Mes enfants";
$pageDescription="Mes enfants";
$pageHelp="";
if(!isset($_COOKIE["ID_UTILISATEUR"])){
	header("Location: ../index.php");
	exit;
}
include_once("../header.inc.php");
include_once("../include/functions.php");
include_once("../include/protect_var.php");
connectSQL();
//entete_page($GLOBALS['params']['appli']['title_appli']." - ".$titre,'');
?>
<!-- Calendrier -->      
<link rel="stylesheet" type="text/css" href="content/calendar/calendar-blue2.css">
<script type="text/javascript" src="content/calendar/calendar.js"></script>
<script type="text/javascript" src="content/calendar/lang/calendar-fr.js"></script>
<script type="text/javascript" src="content/calendar/calendar-setup.js"></script>
<script type="text/javascript">
jQuery(document).ready(function(){
	jQuery("input").focus(function() {
		jQuery("#mess").hide();
	});
	jQuery("input").focus(function() {
		jQuery("#mess2").hide();
	});
	jQuery('#myForm').each( function(){
		jQuery(this).validate({			
			debug: false,
			rules: {
				/*uniqId0: "required",*/
				nom: {
					required: function(element) {
						return jQuery("#addEnfant").is(":visible");
					}
				},
				prenom: {
					required: function(element) {
						return jQuery("#addEnfant").is(":visible");
					}
				}			
			},
			messages: {
				nom: "Ce champ est obligatoire",
				prenom: "Ce champ est obligatoire"				
			},
			submitHandler: function(form) {			
				var datas = jQuery(form).serialize();		
	            jQuery.ajax({
	                cache: false,
	                type: 'POST',
	                data: datas,
	                url : '<?php echo $script;?>',
	                success: function (response) {                    
	                    jQuery("#mess").attr('class','mess');
	                    jQuery("#mess").show(1500);
	                    if (response=="Enregistrement effectué"){
		                    alert(response);	                    			                                   
		                    jQuery("#container").load('main/<?php echo $page;?>');		                    
	                    }
	                    jQuery("#mess").html(response);
	                },
	                error: function(data, textStatus, jqXHR) {
	                	jQuery("#mess").attr('class','messErr');
	                    jQuery("#mess").show(1500);
	                    jQuery("#mess").html("data");                	
	                }
	            })
			}
		});
	});	
	jQuery('.editForm').each( function(){
		jQuery(this).validate({	
			debug: false,	
			rules: {
				/*uniqId0: "required",*/
				nom: 'required',
				prenom: 'required'				
			},
			messages: {
				nom: "Ce champ est obligatoire",
				prenom: "Ce champ est obligatoire",				
			},	
			submitHandler: function(form) {			
				var datas = jQuery(form).serialize();		
	            jQuery.ajax({
	                cache: false,
	                type: 'POST',
	                data: datas,
	                url : '<?php echo $script;?>',
	                success: function (response) {                    
	                    jQuery("#mess").attr('class','mess');
	                    jQuery("#mess").show(1500);	                   
	                    jQuery("#mess").html(response);
	                },
	                error: function(data, textStatus, jqXHR) {
	                	jQuery("#mess").attr('class','messErr');
	                    jQuery("#mess").show(1500);
	                    jQuery("#mess").html(data);                	
	                }
	            })
			}
		});
	});	
	jQuery("#myForm2").validate({
		debug: false,
		rules: {
			idParent: "required",
		},			
		messages: {
			idParent: "Ce champ est obligatoire",		
		},				
		submitHandler: function(form) {			
			var datas = jQuery("#myForm2").serialize();				
            jQuery.ajax({
                cache: false,
                type: 'POST',
                data: datas,
                url : 'scripts/assoc_parent.php',
                success: function (response) {                    
                    jQuery("#mess2").attr('class','mess');
                    jQuery("#mess2").show(1500);
                    jQuery("#mess2").html(response);
                },
                error: function(data, textStatus, jqXHR) {
                	jQuery("#mess2").attr('class','messErr');
                    jQuery("#mess2").show(1500);
                    jQuery("#mess2").html(data);                	
                }
            })
		}
	});
	jQuery('.myFormDelete').each( function(){
		jQuery(this).validate({
			debug: false,		
			submitHandler: function(form) {			
				var datas = jQuery(form).serialize();		
	            jQuery.ajax({
	                cache: false,
	                type: 'POST',
	                data: datas,
	                url : '<?php echo $script;?>',
	                success: function (response) {                    
	                    jQuery("#mess").attr('class','mess');
	                    jQuery("#mess").show(1500);
	                    if (response=="Suppression effectuée"){	                    			                           
		                    jQuery("#container").load('main/<?php echo $page;?>');		                    
	                    }
	                    jQuery("#mess").html(response);
	                },
	                error: function(data, textStatus, jqXHR) {
	                	jQuery("#mess").attr('class','messErr');
	                    jQuery("#mess").show(1500);
	                    jQuery("#mess").html("data");                	
	                }
	            });
			}
		});
	});
});
function changeId(id){	
	jQuery("#idEnfant").val(id);
}
</script>
</head>
<body>
<div class="highslide-html-content" id="highslide-html2<?php echo $page;?>">
	<div class="highslide-header">	
	</div>
	<div class="highslide-body">
		<?php echo $pageHelp;?>			
	</div>
    <div class="highslide-footer">
        <div>
            <span class="highslide-resize" title="Resize">
                <span></span>
            </span>
        </div>
    </div>
</div>
<div class="highslide-html-content" id="assocParent">
	<div class="highslide-header"></div>
	<div class="highslide-body">		
		<div id="mess2" style="display: none;"></div>
		<div class="content">			
			<form method="post" id="myForm2" action="#">			
			<input type="hidden" name="uniqIdEnfant" id="idEnfant">
			<table align="center"><tr><td>			   
			<select name="idParent"><option value=""></option>
			<?php 
			$req="SELECT uniqId FROM lien WHERE id_user=$_COOKIE[ID_UTILISATEUR] ORDER BY date_lien;";	
			$rec=@mysql_query($req) or die('erreur<br/>'.mysql_error());				
			while ($res=mysql_fetch_array($rec)){
				$reqUser="SELECT nom,prenom,id FROM user WHERE uniqId='$res[uniqId]'";
				$resUser=mysql_fetch_array(mysql_query($reqUser));
				echo "<option value=\"$resUser[id]\">$resUser[prenom] $resUser[nom]</option>";
			}
			?>
			</select></td></tr>
			<tr><td><button type="submit" id="submitButton2" name="valid" value="Valider" style="cursor: pointer;">Valider</button></td></tr>
			</table>
			</form>			
		</div>			
	</div>
    <div class="highslide-footer">
        <div>
            <span class="highslide-resize" title="Resize">
                <span></span>
            </span>
        </div>
    </div>
</div>
<div id="container2">
	<h1><?php  echo $titre;?></h1>
		<h2><?php  echo $pageDescription;?></h2>	
		<div id="mess" style="display: none;"></div>
		<div id="help" title="Aide"><a href="#" onclick="return hs.htmlExpand(this, { contentId: 'highslide-html2<?php echo $page;?>',headingText: 'Aide',preserveContent: false } );"></a></div>
	<div class="content">
		<?php 		
		$nbEnfant=0;		
		$req="SELECT * FROM enfant WHERE id_parent1=$_COOKIE[ID_UTILISATEUR] OR id_parent2=$_COOKIE[ID_UTILISATEUR] ORDER BY date_naissance;";	
		$rec=@mysql_query($req);				
		?>		
		<input type="hidden" name="page" value="<?php echo $page;?>">
		<div>
		<p style="cursor: pointer;text-decoration: underline;margin:0 ;padding: 0;" onclick="affiche('addEnfant','');afficheSi('validButton','nbEnfant');"><img src="graphs/icons/add16.png">&nbsp;Ajouter un enfant</p>
		</div>
		<div style="display: none" id="addEnfant">
			<form method="post" id="myForm" action="#" style="display: inline; margin:0 padding:0;">
			<table style="width: 100%;">												
				<tr><td>Genre</td><td><select name="genre">
					<option value="0"></option>
					<option value="1">Fille</option>
					<option value="2">Garçon</option>
					</select></td>
				</tr>
				<tr><td>Nom</td><td><input name="nom"></td></tr>
				<tr><td>Prénom</td><td><input name="prenom"></td></tr>	
				<tr><td>Né le</td>
				<td>
					<input style="vertical-align: middle;" readonly type="text" size=6 name="date_naissance" id="data1">
                    <img src="graphs/icons/cal.png" id="f_trigger_a"
                    style="text-align: left;cursor: pointer; vertical-align: middle; margin: 0;pading: 0;"
					title="Choisissez une date"
					onmouseover="this.style.background='blue';"
					onmouseout="this.style.background=''"/>
						<script type="text/javascript">
							Calendar.setup({
                            	inputField     :    "data1",
                                ifFormat       :    "%Y-%m-%d",
                                button         :    "f_trigger_a",
                                singleClick    :    true
                             });
                        </script>					
				</td></tr>		
				<tr><td>Fête</td>
				<td>
					<input style="vertical-align: middle;" readonly type="text" size=6 name="date_fete" id="data2">
                    <img src="graphs/icons/cal.png" id="f_trigger_b"
                    style="text-align: left;cursor: pointer; vertical-align: middle; margin: 0;pading: 0;"
					title="Choisissez une date"
					onmouseover="this.style.background='blue';"
					onmouseout="this.style.background=''"/>
						<script type="text/javascript">
							Calendar.setup({
                            	inputField     :    "data2",
                                ifFormat       :    "%Y-%m-%d",
                                button         :    "f_trigger_b",
                                singleClick    :    true
                             });
                        </script>					
				</td></tr>				
			</table>
			<p id="validButtonAdd"><button type="submit" id="submitButtonAdd" name="add" value="Valider" style="cursor: pointer;">Valider</button></p>
			</form>						
		</div>		
		<div id="majEnfant">			
			<?php 			
			while ($res=@mysql_fetch_array($rec)){				
				$nbEnfant++;				
				$idForCal=trim((rawurlencode(chiffre("$res[id]", "$_SESSION[UNIQID]")));
				$typeForCal=trim(rawurlencode(chiffre("enfant", "$_SESSION[UNIQID]")));
				echo "<table style=\"width: 100%;\">";
				echo "<tr><td colspan=2 class=\"separ\">";
				if (empty($res['id_parent1']) || empty($res['id_parent2'])){
					echo "<div class=\"partage\" title=\"Associer cet enfant à un second parent\" onclick=\"changeId('$res[uniqId]');return hs.htmlExpand(this, { contentId: 'assocParent',headingText: 'Associer $res[prenom] $res[nom]' } );\"></div>";
				}
				echo "<div class=\"identifiant\" style=\"display: inline-block;\">Enfant $nbEnfant : $res[uniqId]</div>
				<div class=\"infoLien\">";							
				echo "<form method=\"post\" class=\"myFormDelete\" action=\"#\" style=\"display: inline\">";
				echo "<input type =\"hidden\" name=\"id\" value=\"$res[id]\">";
				echo "<input type=\"submit\" name=\"del\" value=\"\" style=\"background-image: url(graphs/icons/supp.png);
				background-repeat:no-repeat;					
				background-color: transparent;border: none;
				cursor: pointer;\" title=\"Supprimer cet enfant\" onclick=\"
				return(confirm('Voulez-vous vraiment supprimer cet enfant ?'));					
				\">&nbsp;&nbsp;&nbsp;";
				echo "</form>	
				<img style=\"cursor: pointer;\" src=\"graphs/icons/agenda.png\" title=\"Agenda\" onclick=\"return hs.htmlExpand(this, { src: 'content/wdCalendar/wdCalendar/calendar.php?awq=$idForCal&zxs=$typeForCal',objectType: 'iframe', headingText: 'Agenda de $res[prenom] $res[nom]',width: 640,preserveContent: false });\">							
				</div>
				</td></tr></table>				
				<form method=\"post\" id=\"formEdit$res[id]\" class=\"editForm\" action=\"#\" style=\"display: inline; margin:0 padding:0;\">
				<input type =\"hidden\" name=\"id\" value=\"$res[id]\">
				<table style=\"width: 100%;\">	
				";
				if ($res['id_parent1']==$_COOKIE['ID_UTILISATEUR']){
					if (!empty($res['id_parent1'])){
						$parent2=$res['id_parent2'];
					}
				}elseif($res['id_parent2']==$_COOKIE['ID_UTILISATEUR']){
					if (!empty($res['id_parent2'])){
						$parent2=$res['id_parent1'];
					}
				}
				echo "<tr><td>Parent(s)</td><td>$_COOKIE[PRENOM] $_COOKIE[NOM]";
				$reqParent="SELECT nom,prenom FROM user WHERE id='$parent2'";
				$resParent=mysql_fetch_array(mysql_query($reqParent));
				if ($resParent){
					echo " et $resParent[prenom] $resParent[nom]";
				}
				echo "</td></tr>";
				echo "<tr><td>Genre</td><td><select name=\"genre\">
					<option value=\"0\"";
				if ($res['genre']==0){ echo ' selected';}
				echo "></option>
					<option value=\"1\"";
				if ($res['genre']==1){ echo ' selected';}
				echo ">Fille</option>
					<option value=\"2\"";
				if ($res['genre']==2){ echo ' selected';}
				echo ">Garçon</option>
					</select></td></tr>
					";
				echo "<tr><td>Nom</td><td><input name=\"nom\" value=\"$res[nom]\"></td></tr>
				<tr><td>Prénom</td><td><input name=\"prenom\" value=\"$res[prenom]\"></td></tr>
				<tr><td>Né le</td>
				<td>
				<input style=\"vertical-align: middle;\" readonly type=\"text\" size=6 name=\"date_naissance$nbEnfant\" value=\"$res[date_naissance]\" id=\"data3$nbEnfant\">
                    <img src=\"graphs/icons/cal.png\" id=\"f_trigger_c$nbEnfant\"
                    style=\"text-align: left;cursor: pointer; vertical-align: middle; margin: 0;pading: 0;\"
					title=\"Choisissez une date\"
					onmouseover=\"this.style.background='blue';\"
					onmouseout=\"this.style.background=''\"/>
						<script type=\"text/javascript\">
							Calendar.setup({
                            	inputField     :    \"date_naissance$nbEnfant\",
                                ifFormat       :    \"%Y-%m-%d\",
                                button         :    \"f_trigger_c$nbEnfant\",
                                singleClick    :    true
                             });
                        </script>	
				</td></tr>
				<tr><td>Fête</td>
				<td>
				<input style=\"vertical-align: middle;\" readonly type=\"text\" size=6 name=\"date_fete$nbEnfant\" value=\"$res[date_fete]\" id=\"data4$nbEnfant\">
                    <img src=\"graphs/icons/cal.png\" id=\"f_trigger_d$nbEnfant\"
                    style=\"text-align: left;cursor: pointer; vertical-align: middle; margin: 0;pading: 0;\"
					title=\"Choisissez une date\"
					onmouseover=\"this.style.background='blue';\"
					onmouseout=\"this.style.background=''\"/>
						<script type=\"text/javascript\">
							Calendar.setup({
                            	inputField     :    \"date_fete$nbEnfant\",
                                ifFormat       :    \"%Y-%m-%d\",
                                button         :    \"f_trigger_d$nbEnfant\",
                                singleClick    :    true
                             });
                        </script>	
				</td></tr>
				<input type=\"hidden\" name=\"nbEnfant\" id=\"nbEnfant\" value=\"$nbEnfant\">
				<tr><td><button type=\"submit\" name=\"valid\" value=\"Valider\" style=\"cursor: pointer;\">Valider</button></td></tr>
				</table>
				</form>";				 
			}
			?>						
		</div>						
	</div>
</div>
</body>
</html>