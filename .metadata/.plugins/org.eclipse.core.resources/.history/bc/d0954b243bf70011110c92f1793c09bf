<?php
// Redirige l'utilisateur s'il est déjà identifié
session_start();
if(isset($_COOKIE["ID_UTILISATEUR"])){
      header("Location: ../menu.php");
}else{
	include_once("../header.inc.php");
	include_once("../include/functions.php");	
	require_once('../include/phpmailer/class.phpmailer.php');
     // Formulaire visible par défaut
     $masquer_formulaire = false;
     
     // Une fois le formulaire envoyé
     if(isset($_POST["valid"])){
          
          // Vérification de la validité des champs
          if (!filter_var($_POST["TB_Adresse_Email"], FILTER_VALIDATE_EMAIL)){
               echo "Votre adresse e-mail n'est pas valide";              
          }else{               
               // Connexion à la base de données              
          	   connectSQL();  
          	   include_once("../include/protect_var.php");
          	   $reqTest="SELECT id FROM user WHERE mail1='$_POST[TB_Adresse_Email]'";
          	   $recTest=mysql_query($reqTest);
          	   if (mysql_num_rows($recTest)>0){	                                                                  
                         // Génération du mot de passe
                         $resTest=mysql_fetch_array($recTest);
                         $caracteres = array("a", "b", "c", "d", "e", "f", 0, 1, 2, 3, 4, 5, 6, 7, 8, 9);
                         $caracteres_aleatoires = array_rand($caracteres, 8);
                         $clef_activation = "";
                         
                         foreach($caracteres_aleatoires as $i){
                              $clef_activation .= $caracteres[$i];
                         }
                         $uniqId=uniqid();
                         // Création du compte utilisateur
                         $req="
                              INSERT INTO user(
                                   login
                                   , password
                                   , mail1
                                   , date_inscription
                                   , clef_activation
                                   , uniqId
                              )
                              VALUES(
                                   '" . $_POST["TB_Nom_Utilisateur"] . "'
                                   , '" . md5($_POST["TB_Mot_de_Passe"]) . "'
                                   , '" . $_POST["TB_Adresse_Email"] . "'
                                   , '" . time() . "'
                                   , '" . $clef_activation . "'
                                   , '" . $uniqId . "'
                              )
                         ";                       
                         $result = mysql_query($req);
                         
                         // Si une erreur survient
                         if(!$result){
                              echo "Erreur d'accès à la base de données lors de la création du compte utilisateur";                                                         
                         }else{                              
                              // Envoi du mail d'activation
                              $sujet = "Activation de votre compte utilisateur";
                              
                              $message = "Pour valider votre inscription, merci de cliquer sur le lien suivant :\n";
                              $message .= $GLOBALS['params']['appli']['proto']."://" . $_SERVER["SERVER_NAME"];
                              $message .= $GLOBALS['params']['appli']['root_folder']."/resources/activate_password.php?id=" . mysql_insert_id();
                              $message .= "&activation=" . $clef_activation;
                              $mail = new PHPMailer();
                              $mail->IsSMTP();
                              #$mail->Host = $GLOBALS['params']['appli']['exp_name']['smtp_host'];
                              $mail->From = $GLOBALS['params']['appli']['exp_mail'];
                              $mail->FromName = $GLOBALS['params']['appli']['exp_name'];
                              $mail->AddAddress($_POST["TB_Adresse_Email"]);
                              $mail->Subject = $sujet;
                              $mail->Body = $message;
                             // $mail->Send();
                              // Si une erreur survient
                              //if(!@mail($_POST["TB_Adresse_Email"], $sujet, $message)){
                              if ( !$mail->Send() ) {
                                  echo "Une erreur est survenue lors de l'envoi du mail d'activation";                                                                   
                              }else{
                                   
                                   // Message de confirmation
                                   echo "Compte créé ! Un email vient de vous être envoyé afin de l'activer";                                                                     
                                   // On masque le formulaire
                                   $masquer_formulaire = true;
                                   
                              }                              
                         }                  
          	   }else{
          	   	echo "Cette adresse mail n'existe pas !";
          	   }      
               // Fermeture de la connexion à la base de données
               mysql_close();
	               
          }                             
     }     
}