<?PHP
$page="lien.php";
$script="scripts/update_lien.php";
$titre="Mes liens";
$pageDescription="Gestion du rattachement entre utilisateurs";
$pageHelp="Pour vous connecter sur xxxx vous devez disposer d'un compte valide. <br/><br/>
		<b><i>J'ai déjà un compte</i></b> <br/>						
		Saisissez le nom d'utilisateur et le mot qui vous ont été fourni et cliquez sur le bouton \"Connexion\".<br/>	<br/>
		<b><i>Je n'ai pas de compte</i></b> <br/>
		Cliquez sur le bouton \"Créer un compte\", une nouvelle fenêtre s'ouvre vous demandant des renseignements de base<br/>
		Saisissez les informations demandées.<br/><br/>
		Notez que vous devriez utiliser un mot de passe comportant <b>au moins 8 caratères</b> mélangeant des chiffres et des lettres.<br/><br/>
		Une fois les informations saisies, cliquez sur \"Valider\".
		<br/><br/>
		<b><i>J'ai perdu mon mot de passe</i></b>";
$tabicone=array("0"=>"<img src='graphs/icons/nok.png'>","1"=>"<img src='graphs/icons/ok.png'>");
if(!isset($_COOKIE["ID_UTILISATEUR"])){
	header("Location: ../index.php");
	exit;
}
include_once("../header.inc.php");
include_once("../include/functions.php");
include_once("../include/protect_var.php");
//entete_page($GLOBALS['params']['appli']['title_appli']." - ".$titre,'');
?>
<!-- Calendrier -->      
<link rel="stylesheet" type="text/css" href="content/calendar/calendar-blue2.css">
<script type="text/javascript" src="content/calendar/calendar.js"></script>
<script type="text/javascript" src="content/calendar/lang/calendar-fr.js"></script>
<script type="text/javascript" src="content/calendar/calendar-setup.js"></script>
<script type="text/javascript">
jQuery(document).ready(function(){
	jQuery("input").focus(function() {
		jQuery("#mess").hide();
	});
	jQuery("#myForm").validate({
		debug: false,
		rules: {
			/*uniqId0: "required",*/
			uniqId0: {
				required: function(element) {
					return jQuery("#addLien").is(":visible");
				}
			},
			type0: {
				required: function(element) {
					return jQuery("#addLien").is(":visible");
				}
			}			
		},
		messages: {
			uniqId0: "L'identifiant personnel de l'utilisateur est obligatoire",
			type0: "Vous devez préciser qui est la personne",				
		},
		submitHandler: function(form) {			
			var datas = jQuery(form).serialize();		
            jQuery.ajax({
                cache: false,
                type: 'POST',
                data: datas,
                url : '<?php echo $script;?>',
                success: function (response) {                    
                    jQuery("#mess").attr('class','mess');
                    jQuery("#mess").show(1500);
                    if (response=="Enregistrement effectué"){	                    			                                   
	                    jQuery("#container").load('main/<?php echo $page;?>');		                    
                    }
                    jQuery("#mess").html(response);
                },
                error: function(data, textStatus, jqXHR) {
                	jQuery("#mess").attr('class','messErr');
                    jQuery("#mess").show(1500);
                    jQuery("#mess").html(data);                	
                }
            })
		}
	});
	jQuery('.myFormDelete').each( function(){
		jQuery(this).validate({
			debug: false,		
			submitHandler: function(form) {			
				var datas = jQuery(form).serialize();		
	            jQuery.ajax({
	                cache: false,
	                type: 'POST',
	                data: datas,
	                url : '<?php echo $script;?>',
	                success: function (response) {                    
	                    jQuery("#mess").attr('class','mess');
	                    jQuery("#mess").show(1500);
	                    if (response=="Suppression effectuée"){	                    			                           
		                    jQuery("#container").load('main/<?php echo $page;?>');		                    
	                    }
	                    jQuery("#mess").html(response);
	                },
	                error: function(data, textStatus, jqXHR) {
	                	jQuery("#mess").attr('class','messErr');
	                    jQuery("#mess").show(1500);
	                    jQuery("#mess").html("data");                	
	                }
	            });
			}
		});
	});	
});
jQuery(document).ready( function() {
    jQuery("img[title]").tooltip({
		// tweak the position
        offset: [0, 0],
        // use the "slide" effect        
        //position: 'bottom right' ,
        effect: 'slide'              
        // add dynamic plugin with optional configuration for bottom edge
    }).dynamic({ bottom: { direction: 'down', bounce: true } });    
});
</script>
</head>
<body>
<div class="highslide-html-content" id="highslide-html2">
	<div class="highslide-header">	
	</div>
	<div class="highslide-body">
		<?php echo $pageHelp;?>			
	</div>
    <div class="highslide-footer">
        <div>
            <span class="highslide-resize" title="Resize">
                <span></span>
            </span>
        </div>
    </div>
</div>

<div id="container2">
	<h1><?php  echo $titre;?></h1>
		<h2><?php  echo $pageDescription;?></h2>	
		<div id="mess" style="display: none;"></div>
		<div id="help" title="Aide"><a href="#" onclick="return hs.htmlExpand(this, { contentId: 'highslide-html2',headingText: 'Aide' } )"></a></div>
	<div class="content">
		<?php 		
		$nbLien=0;
		connectSQL();
		$req="SELECT * FROM lien WHERE id_user=$_COOKIE[ID_UTILISATEUR] ORDER BY date_lien;";	
		$rec=@mysql_query($req)
		?>
		<form method="post" id="myForm" action="#">
		<input type="hidden" name="page" value="<?php echo $page;?>">
		<div>
		<p style="cursor: pointer;text-decoration: underline;margin:0 ;padding: 0;" onclick="affiche('addLien','');afficheSi('validButton','nbLien');"><img src="graphs/icons/add16.png">&nbsp;Ajouter un lien</p>
		</div>
		<div style="display: none" id="addLien">
			<table style="width: 100%">																
				<tr><td style="width: 150px;">Identifiant unique de la personne</td><td><input size=17 name="uniqId<?php echo $nbLien;?>"></td></tr>
				<tr><td colspan=2><i>13 caractères accessibles dans la rubrique "Mon compte" de chaque utilisateur</i></td></tr>
				<tr><td>Qui est-ce ?</td><td><select name="type<?php echo $nbLien;?>">
					<option></option>
					<option value="1">Un parent</option>
					<option value="2">Un enfant</option>
					<option value="3">Une assistante maternelle</option>
					</select></td>
				</tr>				
			</table>
		</div>
		<div id="majLien">
			<table style="width: 100%">			
			<?php 
			while ($res=@mysql_fetch_array($rec)){
				$nbLien++;
				if ($res['type']==1 || $res['type']==3){
					$table='user';
				}elseif ($res['type']==2){
					$table='enfant';
				}				
				$reqUser="SELECT id,nom,prenom,pseudo,adresse,cp,ville,tel1,tel2,tel_por1,tel_por2,mail1,mail2 FROM $table WHERE uniqId='$res[uniqId]'";
				$resUser=mysql_fetch_array(mysql_query($reqUser));		
				$infoUser="<table>
				<caption style='background-color: #0F3F6F;color: #fff;'>Fiche Identité</caption>
				<tr><td>Nom</td><td>&nbsp;:&nbsp;$resUser[nom]</td></tr>
				<tr><td>Prénom</td><td>&nbsp;:&nbsp;$resUser[prenom]</td></tr>
				<tr><td>Pseudo</td><td>&nbsp;:&nbsp;$resUser[pseudo]</td></tr>
				<tr><td>Adresse</td><td>&nbsp;:&nbsp;$resUser[adresse]</td></tr>
				<tr><td>CP</td><td>&nbsp;:&nbsp;$resUser[cp]</td></tr>
				<tr><td>Ville</td><td>&nbsp;:&nbsp;$resUser[ville]</td></tr>
				<tr><td>Tel 1</td><td>&nbsp;:&nbsp;$resUser[tel1]</td></tr>
				<tr><td>Tel 2</td><td>&nbsp;:&nbsp;$resUser[tel2]</td></tr>
				<tr><td>Portable 1</td><td>&nbsp;:&nbsp;$resUser[tel_por1]</td></tr>
				<tr><td>Portable 2</td><td>&nbsp;:&nbsp;$resUser[tel_por2]</td></tr>				
				<tr><td>Mail 1</td><td>&nbsp;:&nbsp;$resUser[mail1]</td></tr>
				<tr><td>Mail 2</td><td>&nbsp;:&nbsp;$resUser[mail2]</td></tr>
				</table>
				";		
				$affUser="<img src=\"graphs/icons/infoUser.png\" title=\"$infoUser\">";			
				//Si c'est une ASM				
				if ($res['type']==3){				
					$reqAsm="SELECT CB,CHQ,VIR,ESP,CESU,permis,agrement,agrement_fin,date_format(agrement_fin, '%d-%m-%Y') AS agrement_fin_fr,id_logement FROM asm WHERE id_user='$resUser[id]'";
					$resAsm=mysql_fetch_array(mysql_query($reqAsm));					
					$infoAsm="<table>
					<caption style='background-color: #0F3F6F;color: #fff;'>Fiche Assistant(e) Maternel(le)</caption>
					<tr><td>Agréé(e) pour</td><td>&nbsp;:&nbsp;$resAsm[agrement]&nbsp;enfant(s)</td></tr>
					<tr><td>Fin agrément</td><td";
					if ($resAsm[agrement_fin]<=date('Y-m-d')){$infoAsm.=" style='color: #ff0000; font-weight: bold;'";}
					$infoAsm.=">&nbsp;:&nbsp;$resAsm[agrement_fin_fr]</td></tr>
					<tr><td>Permis B</td><td>&nbsp;:&nbsp;".$tabicone[$resAsm['permis']]."</td></tr>	
					<tr><td>Carte bancaire</td><td>&nbsp;:&nbsp;".$tabicone[$resAsm['CB']]."</td></tr>	
					<tr><td>Chèque</td><td>&nbsp;:&nbsp;".$tabicone[$resAsm['CHQ']]."</td></tr>	
					<tr><td>Virement bancaire</td><td>&nbsp;:&nbsp;".$tabicone[$resAsm['VIR']]."</td></tr>	
					<tr><td>Espèce</td><td>&nbsp;:&nbsp;".$tabicone[$resAsm['ESP']]."</td></tr>	
					<tr><td>Tickets CESU</td><td>&nbsp;:&nbsp;".$tabicone[$resAsm['CESU']]."</td></tr>					
					</table>
					";
					$affAsm="<img src=\"graphs/icons/asm.png\" title=\"$infoAsm\">";
					$reqLogement="SELECT * FROM logement WHERE id='$resAsm[id_logement]';";
					$recLogement=mysql_query($reqLogement);
					if (mysql_num_rows($recLogement)>0){
						$resLogement=mysql_fetch_array($recLogement);
						$infoLogement="<table>
						<caption style='background-color: #0F3F6F;color: #fff;'>Fiche Logement</caption>
						<tr><td>Surface du logement</td><td>&nbsp;:&nbsp;$resLogement[superficie_logement]</td></tr>
						<tr><td>Nombre de pièces</td><td>&nbsp;:&nbsp;$resLogement[nb_pieces]</td></tr>
						<tr><td>Nombre de chambres disponibles</td><td>&nbsp;:&nbsp;$resLogement[nb_chambres]</td></tr>
						<tr><td>Surface du terrain</td><td>&nbsp;:&nbsp;$resLogement[superficie_jardin]</td></tr>
						<tr><td>Terrain clos ?</td><td>&nbsp;:&nbsp;".$tabicone[$resLogement['clos']]."</td></tr>
						<tr><td>Animaux</td><td>&nbsp;:&nbsp;".$tabicone[$resLogement['animaux']]."</td></tr>								
						<tr><td colspan=2 style='text-align: center;'>Equipement(s) :</td></tr>
						<tr><td>$resLogement[equipement]</td></tr>	
						<tr><td colspan=2 style='text-align: center;'>Descriptif :</td></tr>
						<tr><td>$resLogement[descriptif]</td></tr>						
						</table>
						";
						$infoLogement="<img src=\"graphs/icons/logement.png\" title=\"$infoLogement\">";
					}
				}
				echo "<tr><td colspan=2 class=\"separ\"><div class=\"identifiant\">$resUser[prenom] $resUser[nom] : $res[uniqId]</div>
				<div class=\"infoLien\">
					$infoLogement&nbsp;&nbsp;$affAsm&nbsp;&nbsp;$affUser&nbsp;&nbsp;";
					echo "<form method=\"post\" class=\"myFormDelete\" action=\"#\" style=\"display: inline\">";
					echo "<input type =\"hidden\" name=\"id\" value=\"$res[id]\">";
					echo "<input type=\"submit\" name=\"del\" value=\"\" style=\"background-image: url(graphs/icons/supp.png);
					background-repeat:no-repeat;					
					background-color: transparent;border: none;
					cursor: pointer;\" title=\"Supprimer ce lien\" onclick=\"
					return(confirm('Voulez-vous vraiment supprimer ce lien ?'));					
					\">&nbsp;&nbsp;&nbsp;";
					echo "</form>
					</div></td></tr>";
				echo "<tr><td style=\"width: 100px;\">Type</td><td><select name=\"type$nbLien\">
					<option value=\"0\"";
				if ($res['type']==0){ echo ' selected';}
				echo "></option>
					<option value=\"1\"";
				if ($res['type']==1){ echo ' selected';}
				echo ">Parent</option>
					<option value=\"2\"";
				if ($res['type']==2){ echo ' selected';}
				echo ">Enfant</option>
				<option value=\"3\"";
				if ($res['type']==3){ echo ' selected';}
				echo ">Assistance maternelle</option>
				</select></td></tr>";
				echo "<tr><td>Date du lien</td><td>$res[date_lien]</td></tr>";
				echo "<input type =\"hidden\" name=\"uniqId$nbLien\" value=\"$res[uniqId]\">";				
			}			
			?>			
			</table>
		</div>		
		<p id="validButton"
		<?php 
		if ($nbLien==0){echo " style=\"display: none;\"";}
		?> 
		><button type="submit" id="submitButton" name="valid" value="Valider" style="cursor: pointer;">Valider</button></p>
		<input type="hidden" name="nbLien" id="nbLien" value="<?php echo $nbLien;?>">
		</form>
	</div>
</div>
</body>
</html>